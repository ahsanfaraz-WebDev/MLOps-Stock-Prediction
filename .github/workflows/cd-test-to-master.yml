name: CD - Test to Main (Deploy to Production)

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'docker/**'
      - '.github/workflows/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Build Docker image
      run: |
        docker build -f docker/api/Dockerfile -t ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:latest .
        docker build -f docker/api/Dockerfile -t ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:${{ github.sha }} .
    
    - name: Push Docker image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:latest
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:${{ github.sha }}
    
    - name: Verify deployment
      run: |
        # Pull and run the image to verify it works
        docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:latest
        docker run -d -p 8000:8000 --name test-api ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-stock-prediction-api:latest
        sleep 10
        
        # Check health endpoint
        curl -f http://localhost:8000/health || exit 1
        
        # Cleanup
        docker stop test-api
        docker rm test-api
    
    - name: Create deployment tag
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "v$(date +%Y%m%d-%H%M%S)" -m "Deployment from commit ${{ github.sha }}"
        git push origin --tags || echo "Tag push failed"

